<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Dr. Ninad</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .auth-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .auth-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }
        
        .auth-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .booking-section {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .week-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .week-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .week-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .slot-btn {
            padding: 12px;
            background: #f0f9ff;
            border: 2px solid #bfdbfe;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .slot-btn:hover {
            background: #dbeafe;
            border-color: #93c5fd;
        }
        
        .slot-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .slot-btn.booked {
            background: #fee;
            border-color: #fcc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .day-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 12px;
        }
        
        .day-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .info-box {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            float: right;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Book Appointment with Dr. Ninad</h1>
            <p>Schedule your visit - Monday to Friday, 9 AM to 5 PM</p>
        </div>
        
        <div class="content">
            <div id="message" class="message"></div>
            
            <div id="authSection" class="auth-section">
                <h2 style="margin-bottom: 20px;">Welcome!</h2>
                <p style="margin-bottom: 30px; color: #666;">Please sign in to book an appointment</p>
                <button onclick="handleAuth()" class="auth-btn">üîê Sign in with Google</button>
            </div>
            
            <div id="bookingSection" class="booking-section">
                <button onclick="handleSignOut()" class="logout-btn">Sign Out</button>
                <div style="clear: both;"></div>
                
                <div class="info-box">
                    <strong>‚è∞ Available Hours:</strong> Monday - Friday, 9:00 AM - 5:00 PM (IST)<br>
                    <strong>üìå Slot Duration:</strong> 15, 30, 45, or 60 minutes
                </div>
                
                <form id="appointmentForm">
                    <div class="form-group">
                        <label>üë§ Full Name *</label>
                        <input type="text" id="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üìß Email *</label>
                        <input type="email" id="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üì± Phone Number *</label>
                        <input type="tel" id="phone" required placeholder="+91 1234567890">
                    </div>
                    
                    <div class="form-group">
                        <label>üìù Purpose of Visit *</label>
                        <textarea id="purpose" required placeholder="Please describe the purpose of your visit..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>‚è±Ô∏è Appointment Duration *</label>
                        <select id="duration" required>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">60 minutes (1 hour)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìÖ Select Week</label>
                        <div class="week-selector">
                            <button type="button" class="week-btn active" onclick="selectWeek('current')">
                                This Week
                            </button>
                            <button type="button" class="week-btn" onclick="selectWeek('next')">
                                Next Week
                            </button>
                        </div>
                    </div>
                    
                    <div id="slotsContainer" class="loading">
                        Loading available slots...
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submitBtn" disabled>
                        Book Appointment
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const CLIENT_ID = '156714242602-3bn4tb5fgevb271tngeca835e1b94i1b.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/gmail.send';
        const DISCOVERY_DOCS = [
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
        ];
        
        let tokenClient;
        let accessToken = null;
        let selectedWeek = 'current';
        let selectedSlot = null;
        let bookedSlots = [];
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
            });
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        showBookingSection();
                        loadAvailableSlots();
                    }
                },
            });
        }
        
        function handleAuth() {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        function handleSignOut() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
            }
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('bookingSection').style.display = 'none';
        }
        
        function showBookingSection() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('bookingSection').style.display = 'block';
        }
        
        function selectWeek(week) {
            selectedWeek = week;
            document.querySelectorAll('.week-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadAvailableSlots();
        }
        
        async function loadAvailableSlots() {
            const container = document.getElementById('slotsContainer');
            container.innerHTML = '<div class="loading">Loading available slots...</div>';
            
            try {
                const now = new Date();
                const startDate = selectedWeek === 'current' ? 
                    getNextMonday(now) : getNextMonday(new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000));
                
                bookedSlots = await getBookedSlots(startDate);
                
                container.innerHTML = '';
                
                for (let i = 0; i < 5; i++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    
                    const daySection = document.createElement('div');
                    daySection.className = 'day-section';
                    
                    const dayTitle = document.createElement('h3');
                    dayTitle.textContent = formatDate(date);
                    daySection.appendChild(dayTitle);
                    
                    const slotsGrid = document.createElement('div');
                    slotsGrid.className = 'slots-grid';
                    
                    const slots = generateTimeSlots(date);
                    slots.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'slot-btn';
                        btn.textContent = slot.time;
                        
                        if (isSlotBooked(slot.start)) {
                            btn.classList.add('booked');
                            btn.disabled = true;
                        } else {
                            btn.onclick = () => selectSlot(slot, btn);
                        }
                        
                        slotsGrid.appendChild(btn);
                    });
                    
                    daySection.appendChild(slotsGrid);
                    container.appendChild(daySection);
                }
            } catch (error) {
                container.innerHTML = '<div class="message error">Error loading slots. Please try again.</div>';
                console.error('Error loading slots:', error);
            }
        }
        
        function getNextMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? 1 : day === 6 ? 2 : day === 1 ? 0 : 8 - day;
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        function generateTimeSlots(date) {
            const slots = [];
            const startHour = 9;
            const endHour = 17;
            
            for (let hour = startHour; hour < endHour; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const slotDate = new Date(date);
                    slotDate.setHours(hour, minute, 0, 0);
                    
                    slots.push({
                        time: formatTime(hour, minute),
                        start: slotDate
                    });
                }
            }
            
            return slots;
        }
        
        function formatTime(hour, minute) {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
            return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
        }
        
        function formatDate(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }
        
        async function getBookedSlots(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 7);
            
            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': startDate.toISOString(),
                    'timeMax': endDate.toISOString(),
                    'singleEvents': true,
                    'orderBy': 'startTime'
                });
                
                return response.result.items || [];
            } catch (error) {
                console.error('Error fetching events:', error);
                return [];
            }
        }
        
        function isSlotBooked(slotStart) {
            const duration = parseInt(document.getElementById('duration').value) || 15;
            const slotEnd = new Date(slotStart.getTime() + duration * 60000);
            
            return bookedSlots.some(event => {
                const eventStart = new Date(event.start.dateTime);
                const eventEnd = new Date(event.end.dateTime);
                
                return (slotStart < eventEnd && slotEnd > eventStart);
            });
        }
        
        function selectSlot(slot, btn) {
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedSlot = slot;
            document.getElementById('submitBtn').disabled = false;
        }
        
        document.getElementById('duration').addEventListener('change', () => {
            selectedSlot = null;
            document.getElementById('submitBtn').disabled = true;
            loadAvailableSlots();
        });
        
        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedSlot) {
                showMessage('Please select a time slot', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Booking...';
            
            try {
                const duration = parseInt(document.getElementById('duration').value);
                const endTime = new Date(selectedSlot.start.getTime() + duration * 60000);
                
                const event = {
                    summary: `Appointment: ${document.getElementById('name').value}`,
                    description: `Name: ${document.getElementById('name').value}\nPhone: ${document.getElementById('phone').value}\nEmail: ${document.getElementById('email').value}\nPurpose: ${document.getElementById('purpose').value}`,
                    start: {
                        dateTime: selectedSlot.start.toISOString(),
                        timeZone: 'Asia/Kolkata'
                    },
                    end: {
                        dateTime: endTime.toISOString(),
                        timeZone: 'Asia/Kolkata'
                    },
                    attendees: [
                        { email: document.getElementById('email').value }
                    ]
                };
                
                await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event
                });
                
                await sendConfirmationEmail();
                
                showMessage('‚úÖ Appointment booked successfully! Confirmation email sent.', 'success');
                document.getElementById('appointmentForm').reset();
                selectedSlot = null;
                loadAvailableSlots();
            } catch (error) {
                console.error('Error booking appointment:', error);
                showMessage('‚ùå Error booking appointment. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Book Appointment';
            }
        });
        
        async function sendConfirmationEmail() {
            const to = document.getElementById('email').value;
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const purpose = document.getElementById('purpose').value;
            const duration = document.getElementById('duration').value;
            const dateTime = selectedSlot.start.toLocaleString('en-IN', { 
                timeZone: 'Asia/Kolkata',
                dateStyle: 'full',
                timeStyle: 'short'
            });
            
            const emailBody = `Dear ${name},

Your appointment with Dr. Ninad has been confirmed!

Appointment Details:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ Date & Time: ${dateTime}
‚è±Ô∏è Duration: ${duration} minutes
üì± Phone: ${phone}
üìù Purpose: ${purpose}

Please arrive 5 minutes early. If you need to cancel, please contact us at least 24 hours in advance.

If you have any questions, feel free to reply to this email.

Best regards,
Dr. Ninad's Office`;

            const message = [
                'Content-Type: text/plain; charset="UTF-8"\n',
                'MIME-Version: 1.0\n',
                'Content-Transfer-Encoding: 7bit\n',
                `To: ${to}\n`,
                'From: appointment.dr.ninad@gmail.com\n',
                'Subject: Appointment Confirmation - Dr. Ninad\n\n',
                emailBody
            ].join('');

            const encodedMessage = btoa(unescape(encodeURIComponent(message)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');

            await gapi.client.gmail.users.messages.send({
                userId: 'me',
                resource: {
                    raw: encodedMessage
                }
            });
        }
        
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }
        
        window.onload = () => {
            gapi.load('client', initializeGapiClient);
            gisLoaded();
        };
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>